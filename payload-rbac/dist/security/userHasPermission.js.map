{"version":3,"sources":["../../src/security/userHasPermission.ts"],"sourcesContent":["import { PermissionAction } from \"../components/admin/PermissionsField\";\nimport { CollectionSlug, PayloadRequest } from \"payload\";\n\nexport default async function userHasPermission({\n  req,\n  principal,\n  action,\n}: {\n  req: PayloadRequest;\n  principal: string | readonly string[];\n  action: PermissionAction;\n}) {\n  if (!req.user) {\n    return false;\n  }\n\n  if (Number(req.user.id) === 1) {\n    return true;\n  }\n\n  const principals = new Set(\n    (Array.isArray(principal) ? principal : [principal]).filter(Boolean),\n  );\n  if (principals.size === 0) {\n    return false;\n  }\n\n  const userRoles = await req.payload.find({\n    collection: \"roles\" as CollectionSlug,\n    where: {\n      users: {\n        contains: req.user.id,\n      },\n    },\n    req,\n  });\n\n  for (const role of userRoles.docs) {\n    // @ts-ignore\n    const permissions = role.permissions || {};\n\n    for (const principalSlug of principals) {\n      const principalPermissions = permissions[principalSlug];\n      if (principalPermissions?.[action] === true) {\n        return true;\n      }\n    }\n  }\n\n  return false;\n}\n"],"names":["userHasPermission","req","principal","action","user","Number","id","principals","Set","Array","isArray","filter","Boolean","size","userRoles","payload","find","collection","where","users","contains","role","docs","permissions","principalSlug","principalPermissions"],"mappings":"AAGA,eAAe,eAAeA,kBAAkB,EAC9CC,GAAG,EACHC,SAAS,EACTC,MAAM,EAKP;IACC,IAAI,CAACF,IAAIG,IAAI,EAAE;QACb,OAAO;IACT;IAEA,IAAIC,OAAOJ,IAAIG,IAAI,CAACE,EAAE,MAAM,GAAG;QAC7B,OAAO;IACT;IAEA,MAAMC,aAAa,IAAIC,IACrB,AAACC,CAAAA,MAAMC,OAAO,CAACR,aAAaA,YAAY;QAACA;KAAU,AAAD,EAAGS,MAAM,CAACC;IAE9D,IAAIL,WAAWM,IAAI,KAAK,GAAG;QACzB,OAAO;IACT;IAEA,MAAMC,YAAY,MAAMb,IAAIc,OAAO,CAACC,IAAI,CAAC;QACvCC,YAAY;QACZC,OAAO;YACLC,OAAO;gBACLC,UAAUnB,IAAIG,IAAI,CAACE,EAAE;YACvB;QACF;QACAL;IACF;IAEA,KAAK,MAAMoB,QAAQP,UAAUQ,IAAI,CAAE;QACjC,aAAa;QACb,MAAMC,cAAcF,KAAKE,WAAW,IAAI,CAAC;QAEzC,KAAK,MAAMC,iBAAiBjB,WAAY;YACtC,MAAMkB,uBAAuBF,WAAW,CAACC,cAAc;YACvD,IAAIC,sBAAsB,CAACtB,OAAO,KAAK,MAAM;gBAC3C,OAAO;YACT;QACF;IACF;IAEA,OAAO;AACT"}