{"version":3,"sources":["../../../src/components/admin/PermissionsField.tsx"],"sourcesContent":["\"use client\";\n\nimport React, { useCallback, useMemo } from \"react\";\nimport type { FieldClientComponent, StaticDescription } from \"payload\";\n\nimport {\n  FieldDescription,\n  FieldError,\n  FieldLabel,\n  RenderCustomComponent,\n  fieldBaseClass,\n  useConfig,\n  useField,\n} from \"@payloadcms/ui\";\n\nconst baseClass = \"permissions-matrix-field\";\n\nconst actions = [\"read\", \"create\", \"delete\", \"update\"] as const;\nexport type PermissionAction = (typeof actions)[number];\ntype PermissionsMatrix = Record<string, Record<PermissionAction, boolean>>;\n\nfunction isRecord(value: unknown): value is Record<string, unknown> {\n  return !!value && typeof value === \"object\" && !Array.isArray(value);\n}\n\nfunction coerceMatrix(value: unknown): PermissionsMatrix {\n  if (typeof value === \"string\") {\n    try {\n      return coerceMatrix(JSON.parse(value));\n    } catch {\n      return {};\n    }\n  }\n\n  if (!isRecord(value)) return {};\n\n  const matrix: PermissionsMatrix = {};\n\n  for (const [collectionSlug, maybeRow] of Object.entries(value)) {\n    if (!isRecord(maybeRow)) continue;\n\n    matrix[collectionSlug] = {\n      read: Boolean(maybeRow.read),\n      create: Boolean(maybeRow.create),\n      update: Boolean(maybeRow.update),\n      delete: Boolean(maybeRow.delete),\n    };\n  }\n\n  return matrix;\n}\n\nfunction buildMatrix(args: {\n  collectionSlugs: string[];\n  value: unknown;\n}): PermissionsMatrix {\n  const fromValue = coerceMatrix(args.value);\n  const allSlugs = Array.from(\n    new Set([...args.collectionSlugs, ...Object.keys(fromValue)]),\n  ).sort();\n\n  const matrix: PermissionsMatrix = {};\n  for (const slug of allSlugs) {\n    const existing = fromValue[slug];\n    matrix[slug] = {\n      read: Boolean(existing?.read),\n      create: Boolean(existing?.create),\n      update: Boolean(existing?.update),\n      delete: Boolean(existing?.delete),\n    };\n  }\n\n  return matrix;\n}\n\nconst PermissionsField: FieldClientComponent = (props) => {\n  const { field, path: pathFromProps, readOnly } = props;\n  const { config } = useConfig();\n\n  const collectionSlugs = useMemo(() => {\n    const slugs = (config?.collections || [])\n      // Exclude internal Payload collections\n      .filter((collection) => !collection.slug.startsWith(\"payload-\"))\n      .map((collection) => collection.slug)\n      .filter(Boolean);\n\n    return Array.from(new Set(slugs)).sort();\n  }, [config?.collections]);\n\n  const fieldAdmin = (field as any)?.admin as\n    | Record<string, unknown>\n    | undefined;\n  const className =\n    typeof fieldAdmin?.className === \"string\"\n      ? fieldAdmin.className\n      : undefined;\n  const description = fieldAdmin?.description as StaticDescription | undefined;\n\n  const label = (field as any)?.label;\n  const localized = (field as any)?.localized;\n  const required = (field as any)?.required;\n\n  const {\n    customComponents: {\n      AfterInput,\n      BeforeInput,\n      Description,\n      Error,\n      Label,\n    } = {},\n    disabled,\n    initialValue,\n    path,\n    setValue,\n    showError,\n    value,\n  } = useField<unknown>({\n    potentiallyStalePath:\n      typeof pathFromProps === \"string\" ? pathFromProps : undefined,\n  });\n\n  const matrix = useMemo(\n    () => buildMatrix({ collectionSlugs, value: value ?? initialValue }),\n    [collectionSlugs, initialValue, value],\n  );\n\n  const setPermission = useCallback(\n    (collectionSlug: string, action: PermissionAction, enabled: boolean) => {\n      if (readOnly || disabled) return;\n\n      const currentRow = matrix[collectionSlug] || {\n        read: false,\n        create: false,\n        update: false,\n        delete: false,\n      };\n\n      const next: PermissionsMatrix = {\n        ...matrix,\n        [collectionSlug]: {\n          ...currentRow,\n          [action]: enabled,\n        },\n      };\n\n      setValue(next);\n    },\n    [disabled, matrix, readOnly, setValue],\n  );\n\n  return (\n    <div\n      className={[\n        fieldBaseClass,\n        baseClass,\n        className,\n        showError && \"error\",\n        (readOnly || disabled) && \"read-only\",\n      ]\n        .filter(Boolean)\n        .join(\" \")}\n    >\n      <RenderCustomComponent\n        CustomComponent={Label}\n        Fallback={\n          <FieldLabel\n            label={label}\n            localized={localized}\n            path={path}\n            required={required}\n          />\n        }\n      />\n\n      <div className={`${fieldBaseClass}__wrap`}>\n        <RenderCustomComponent\n          CustomComponent={Error}\n          Fallback={<FieldError path={path} showError={showError} />}\n        />\n\n        {BeforeInput}\n\n        <div style={{ overflowX: \"auto\" }}>\n          <table style={{ width: \"100%\", borderCollapse: \"collapse\" }}>\n            <thead>\n              <tr>\n                <th\n                  style={{\n                    textAlign: \"left\",\n                    padding: \"6px 8px\",\n                    borderBottom: \"1px solid var(--theme-elevation-150)\",\n                  }}\n                >\n                  Collection\n                </th>\n                {actions.map((action) => (\n                  <th\n                    key={action}\n                    style={{\n                      textAlign: \"center\",\n                      padding: \"6px 8px\",\n                      borderBottom: \"1px solid var(--theme-elevation-150)\",\n                      width: 92,\n                    }}\n                  >\n                    {action}\n                  </th>\n                ))}\n              </tr>\n            </thead>\n            <tbody>\n              {collectionSlugs.map((collectionSlug) => (\n                <tr key={collectionSlug}>\n                  <td\n                    style={{\n                      padding: \"6px 8px\",\n                      borderBottom: \"1px solid var(--theme-elevation-50)\",\n                    }}\n                  >\n                    <code>{collectionSlug}</code>\n                  </td>\n                  {actions.map((action) => (\n                    <td\n                      key={action}\n                      style={{\n                        textAlign: \"center\",\n                        padding: \"6px 8px\",\n                        borderBottom: \"1px solid var(--theme-elevation-50)\",\n                      }}\n                    >\n                      <input\n                        aria-label={`${collectionSlug}:${action}`}\n                        checked={Boolean(matrix?.[collectionSlug]?.[action])}\n                        disabled={Boolean(readOnly || disabled)}\n                        onChange={(e) =>\n                          setPermission(\n                            collectionSlug,\n                            action,\n                            e.target.checked,\n                          )\n                        }\n                        type=\"checkbox\"\n                      />\n                    </td>\n                  ))}\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n\n        {AfterInput}\n      </div>\n\n      <RenderCustomComponent\n        CustomComponent={Description}\n        Fallback={<FieldDescription description={description} path={path} />}\n      />\n    </div>\n  );\n};\n\nexport default PermissionsField;\n"],"names":["React","useCallback","useMemo","FieldDescription","FieldError","FieldLabel","RenderCustomComponent","fieldBaseClass","useConfig","useField","baseClass","actions","isRecord","value","Array","isArray","coerceMatrix","JSON","parse","matrix","collectionSlug","maybeRow","Object","entries","read","Boolean","create","update","delete","buildMatrix","args","fromValue","allSlugs","from","Set","collectionSlugs","keys","sort","slug","existing","PermissionsField","props","field","path","pathFromProps","readOnly","config","slugs","collections","filter","collection","startsWith","map","fieldAdmin","admin","className","undefined","description","label","localized","required","customComponents","AfterInput","BeforeInput","Description","Error","Label","disabled","initialValue","setValue","showError","potentiallyStalePath","setPermission","action","enabled","currentRow","next","div","join","CustomComponent","Fallback","style","overflowX","table","width","borderCollapse","thead","tr","th","textAlign","padding","borderBottom","tbody","td","code","input","aria-label","checked","onChange","e","target","type"],"mappings":"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"}